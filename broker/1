drop dataverse channels if exists;
create dataverse channels;
use dataverse channels;

create type UserType as closed {
    recordId: string,
    userId: string,
    userName: string,
    password: string,
    email: string
}

create dataset UserDataset (UserType)
primary key recordId;

create type UserSubscriptionType as closed {
    recordId: string,
    userSubscriptionId: string,
    channelSubscriptionId: string,
    userId: string,
    channelName: string,
    timestamp: string,
    lastResultTimestamp: string,
    resultsDataset: string
}

create dataset UserSubscriptionDataset(UserSubscriptionType)
primary key recordId;

create type ChannelSubscriptionType as closed{
    recordId: string,
    channelName:string,
    parameters: string,
    channelSubscriptionId: string
}

create dataset ChannelSubscriptionDataset(ChannelSubscriptionType)
primary key recordId;


create broker brokerA at "http://cert24.ics.uci.edu:8989/notifybroker";

#create broker brokerA at "http://128.195.52.196:8989/notifybroker";
#create broker brokerA at "http://169.234.207.251:8989/notifybroker";

create type TweetMessageTypeuuid as closed {
	tweetid: uuid,
	message-text: string
}

create dataset TweetMessageuuids(TweetMessageTypeuuid)
primary key tweetid autogenerated;

create function NearbyTweetsContainingText($text) {
  for $tweet in dataset TweetMessageuuids
	where contains($tweet.message-text,$text)
	return {"timestamp": current-datetime(), "message" : $tweet.message-text}
};

create repetitive channel nearbyTweetChannel using NearbyTweetsContainingText@1 period duration("PT10S");

insert into dataset TweetMessageuuids(
[{"message-text":"Live man"},
{"message-text":"Dead man"},
{"message-text":"Walking man"},
{"message-text":"Good man"}]
);

